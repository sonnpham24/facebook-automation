<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công cụ tự động quản trị Facebook</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    :root {
      --primary: #4f46e5;
      --secondary: #06b6d4;
      --background: #f3f5fa;
      --card-bg: #fff;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #22223b;
      --radius: 18px;
      --shadow: 0 4px 28px rgba(36,37,47,.08);
      --nav-height: 60px;
    }
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
      font-family: 'Inter', 'Roboto', Arial, sans-serif;
    }
    body {
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
    }
    main {
      max-width: 1000px;
      margin: 32px auto 32px auto;
      padding: 0 10px;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 32px 28px;
      margin-bottom: 32px;
      position: relative;
    }

    /* Navbar */
    .navbar {
      height: var(--nav-height);
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
      padding: 0 30px;
      position: sticky;
      top: 0;
      z-index: 999;
    }
    .nav-left {
      display: flex; align-items: center;
    }
    .logo {
      width: 36px; height: 36px; margin-right: 12px;
    }
    .brand {
      font-size: 1.5rem; font-weight: bold;
      background: linear-gradient(90deg,var(--primary),var(--secondary));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .nav-menu {
      list-style: none;
      display: flex;
      gap: 26px;
    }
    .nav-menu li a {
      text-decoration: none;
      color: var(--text);
      font-weight: 500;
      padding: 9px 12px;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .nav-menu li a:hover,
    .nav-menu li a.active {
      background: var(--secondary);
      color: #fff;
    }
    .nav-right {
      margin-left: 20px;
    }
    .auth-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(90deg,var(--primary),var(--secondary));
      color: #fff;
      border: none;
      padding: 9px 22px;
      border-radius: 18px;
      font-weight: 600;
      text-decoration: none;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(36,37,47,.09);
      transition: background 0.2s, transform 0.2s;
    }
    .auth-btn:hover {
      background: linear-gradient(90deg, var(--secondary), var(--primary));
      transform: translateY(-2px) scale(1.04);
    }
    .nav-toggle {
      display: none;
      cursor: pointer;
      font-size: 2.1rem;
      margin-left: 18px;
    }
    @media (max-width: 800px) {
      .navbar { flex-wrap: wrap; height: auto; padding: 0 10px;}
      .nav-menu { display: none; flex-direction: column; gap: 2px; background: #fff; width: 100vw; position: absolute; left: 0; top: var(--nav-height); box-shadow: 0 8px 20px rgba(0,0,0,.07);}
      .nav-menu.active { display: flex; }
      .nav-right { margin: 12px 0 10px 0; }
      .nav-toggle { display: block; }
    }
    /* Toast Notification */
    #toast {
      position: fixed;
      top: 20px; right: 30px; z-index: 9999;
      background: var(--primary);
      color: #fff;
      padding: 15px 36px;
      border-radius: 12px;
      opacity: 0; pointer-events: none;
      font-weight: 500;
      font-size: 1.08rem;
      box-shadow: 0 4px 28px rgba(36,37,47,.14);
      transition: opacity 0.3s, top 0.3s;
    }
    #toast.show { opacity: 1; pointer-events: all; top: 50px; }
    #toast.success { background: var(--success);}
    #toast.error { background: var(--danger);}

    /* Card Section Headings */
    .card h2 {
      color: var(--primary);
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 20px;
      letter-spacing: 0.5px;
    }

    /* Form + input style (basic) */
    input, textarea, select {
      border: 1.5px solid #e5e7eb;
      padding: 13px 13px;
      border-radius: 9px;
      font-size: 1rem;
      margin-bottom: 17px;
      width: 100%;
      transition: border-color .2s;
      background: #f8fafc;
    }
    input:focus, textarea:focus {
      border-color: var(--primary);
      outline: none;
      background: #fff;
    }
    button, .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      padding: 11px 30px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      margin-top: 5px;
    }
    button:hover, .btn:hover {
      background: var(--secondary);
      transform: translateY(-1px) scale(1.03);
    }
    footer {
      margin: 32px auto 12px auto;
      text-align: center;
      color: #aaa;
      font-size: 0.95rem;
    }

    /* Responsive Card Section */
    @media (max-width: 600px) {
      main { padding: 0 2px; }
      .card { padding: 17px 4px; }
      .nav-menu { top: 52px;}
    }
    
    /* CSS cho phần đăng bài */
    .card.post-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(60,60,120,0.10);
      margin-bottom: 2.5rem;
      padding: 2rem 2.5rem 2.5rem 2.5rem;
    }

    .post-form h2 {
      font-size: 1.45rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .form-group {
      margin-bottom: 1.3rem;
    }

    .flex-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    textarea[name="message"] {
      font-size: 1.1rem;
      min-height: 120px;
      padding: 1.1rem;
      border-radius: 12px;
      border: 1.5px solid #e7e9f3;
      background: #f6f7fb;
      transition: border-color 0.3s;
    }
    textarea[name="message"]:focus {
      border-color: var(--primary);
      background: #fff;
      outline: none;
    }

    .upload-options .option {
      border: 1.5px solid #eaeaea;
      padding: 1.1rem 1rem 1rem 1rem;
      border-radius: 11px;
      background: #f8faff;
      margin-bottom: 0.6rem;
      transition: border-color .3s, box-shadow .3s;
    }
    .upload-options .option:has(input[type="radio"]:checked) {
      border-color: var(--secondary);
      box-shadow: 0 2px 8px rgba(0,196,204,0.08);
    }
    .upload-options label {
      font-weight: 600;
      color: var(--primary);
    }

    .url-input {
      margin-top: 0.8rem;
      width: 100%;
      border-radius: 6px;
      border: 1.2px solid #dde1f1;
      padding: 0.7rem;
      font-size: 1rem;
      background: #f6f8fc;
      transition: border-color 0.3s;
    }
    .url-input:focus {
      border-color: var(--primary);
      background: #fff;
    }

    .upload-btn {
      display: inline-block;
      margin-top: 0.7rem;
      background: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.7rem 1.4rem;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    .upload-btn:hover {
      background: var(--primary);
    }

    .submit-btn {
      width: 100%;
      margin-top: 1.2rem;
      padding: 1rem 0;
      border-radius: 14px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: #fff;
      font-size: 1.14rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,196,204,0.09);
      transition: background 0.28s, box-shadow 0.3s;
    }
    .submit-btn:hover {
      background: linear-gradient(90deg, var(--secondary), var(--primary));
      box-shadow: 0 10px 30px rgba(58, 46, 140, 0.11);
    }
    .scheduled-container {
      margin-top: 2rem;
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 2px 14px rgba(58,46,140,0.08);
      padding: 2.2rem 2.1rem 1.7rem 2.1rem;
    }

    .scheduled-container h3 {
      font-size: 1.32rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1.2rem;
    }

    .scheduled-list-cards {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    .scheduled-card {
      background: #f9faff;
      border-radius: 10px;
      border: 1.4px solid #e6eaf5;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      padding: 1.1rem 1.2rem;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      transition: box-shadow .22s;
      position: relative;
    }
    .scheduled-card:hover {
      box-shadow: 0 4px 18px rgba(58,46,140,0.09);
      border-color: var(--secondary);
    }

    .scheduled-card .sched-status {
      font-size: 1.04rem;
      font-weight: 600;
      border-radius: 5px;
      padding: 0.15rem 0.85rem;
      margin-right: 12px;
      background: #f4f5fc;
      color: #444;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .sched-status.scheduled {
      background: #fff3cd;
      color: #856404;
    }
    .sched-status.posted {
      background: #d4edda;
      color: #155724;
    }
    .sched-status.failed {
      background: #f8d7da;
      color: #721c24;
    }

    .scheduled-card .sched-meta {
      flex: 1;
      min-width: 180px;
    }
    .scheduled-card .sched-time {
      color: var(--primary);
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .scheduled-card .sched-message {
      color: #2d3748;
      margin-top: 4px;
      margin-bottom: 2px;
      font-size: 1rem;
      word-break: break-word;
    }

    .scheduled-card .sched-media {
      margin-left: 18px;
      min-width: 80px;
    }
    .scheduled-card .sched-media img,
    .scheduled-card .sched-media video {
      max-width: 80px;
      max-height: 80px;
      border-radius: 6px;
      box-shadow: 0 2px 7px rgba(0,0,0,0.08);
      margin-top: 0.3rem;
      margin-bottom: 0.2rem;
    }
    .comment-management {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 2px 12px rgba(58,46,140,0.07);
      padding: 2.3rem 2rem 1.4rem 2rem;
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.7rem;
    }
    .template-form {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }
    .template-form textarea {
      flex: 1;
      height: 50px;
      border-radius: 7px;
      font-size: 1rem;
    }
    .btn-main {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.8rem 1.4rem;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.18s, transform 0.2s;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(58,46,140,0.07);
    }
    .btn-main:hover { background: var(--primary); transform: translateY(-2px); }

    .template-list {
      margin-top: 0.8rem;
    }
    .template-list h3 {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    .template-list ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .template-list li {
      background: #f7f8fc;
      border-radius: 8px;
      margin-bottom: 0.6rem;
      padding: 0.88rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.2rem;
      box-shadow: 0 1px 5px rgba(58,46,140,0.03);
      transition: box-shadow .15s;
    }
    .template-list li:hover { box-shadow: 0 3px 10px rgba(58,46,140,0.06); }

    .template-content {
      flex: 1;
      color: #374151;
      font-size: 1rem;
      word-break: break-word;
    }
    .template-actions {
      display: flex;
      gap: 0.4rem;
    }

    .btn-delete {
      background: #fff0f3;
      color: #da2347;
      border: 1.5px solid #faafc1;
      padding: 0.45rem 0.7rem;
      border-radius: 7px;
      cursor: pointer;
      transition: all 0.19s;
      font-weight: 500;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.2rem;
    }
    .btn-delete:hover { background: #fce4ea; color: #fff; border-color: #da2347; }

    .auto-comment, .form-group {
      margin-top: 1rem;
      display: flex;
      gap: 1.1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .btn-secondary {
      background: #e7e9fc;
      color: var(--primary);
      border: none;
      border-radius: 7px;
      padding: 0.7rem 1.3rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.17s;
    }
    .btn-secondary:hover { background: var(--primary); color: #fff; }

    .ai-toggle-flex {
      display: flex;
      width: 100%;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .ai-toggle-right {
      display: flex;
      align-items: center;
      gap: 1.2rem;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 28px;
      vertical-align: middle;
    }
    .switch input { display: none; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background: #ccc; transition: .4s; border-radius: 28px;
    }
    input:checked + .slider { background: var(--primary); }
    input:checked + .slider:before { transform: translateX(28px); }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: #fff;
      border-radius: 50%;
      transition: .4s;
      box-shadow: 0 2px 8px rgba(64,60,150,0.12);
    }
    input:checked + .slider:before {
      transform: translateX(28px);
    }
    .slider.round {
      border-radius: 28px;
    }

    .ai-status-label {
      font-weight: bold;
      font-size: 1.05rem;
      color: var(--primary);
      letter-spacing: 0.5px;
    }

    .desc {
      color: #6b7280;
      font-size: 0.98rem;
      margin-top: 0.3rem;
    }
    @media (max-width: 600px) {
      .comment-management { padding: 1.1rem 0.8rem 1rem 0.8rem; }
      .auto-comment, .form-group { flex-direction: column; align-items: stretch; gap: 0.7rem; }
      .template-form { flex-direction: column; gap: 0.5rem; }
    }
    @media (max-width: 700px) {
      .card.post-card, .post-form {
        padding: 1rem !important;
      }
      .flex-row {
        flex-direction: column;
        gap: 0.7rem;
      }
      .scheduled-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.6rem;
      }
      .scheduled-card .sched-media {
        margin-left: 0;
        margin-top: 0.6rem;
      }
    }

    /* Các style nhỏ khác tùy section sẽ bổ sung thêm nếu cần */
  </style>
</head>

<body>
  <!-- Toast thông báo -->
  <div id="toast"></div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="FB Logo" class="logo">
      <span class="brand">Auto Marketing</span>
    </div>
    <ul class="nav-menu">
      <li><a href="#section-post">Đăng bài</a></li>
      <li><a href="#section-scheduled">Lịch đăng</a></li>
      <li><a href="#section-comments">Comment mẫu</a></li>
      <li><a href="#section-ai">Chatbot AI</a></li>
    </ul>
    <div class="nav-right">
      <a href="/auth/facebook" class="auth-btn" id="authButton">
        <i class="ri-facebook-box-fill"></i> Xác thực với Facebook
      </a>
    </div>
    <div class="nav-toggle" id="navToggle"><i class="ri-menu-line"></i></div>
  </nav>

  <!-- Main Content -->
  <main>
    <!-- Section: Đăng bài mới -->
    <section class="card post-card" id="section-post">
      <div class="post-form">
        <h2><i class="fas fa-pencil-alt"></i> Tạo bài đăng mới</h2>
        <form id="postForm" enctype="multipart/form-data">
          <div class="form-group flex-row">
            <div style="flex:1">
              <label for="postType">Loại đăng bài:</label>
              <select id="postType" name="postType" class="form-control">
                <option value="now">Đăng bài ngay</option>
                <option value="schedule">Hẹn lịch đăng bài</option>
              </select>
            </div>
            <div id="scheduleFields" style="display: none; flex:1; margin-left:1rem;">
              <label for="scheduled_time">Thời gian đăng:</label>
              <input type="datetime-local" id="scheduled_time" name="scheduled_time" class="form-control">
            </div>
          </div>
          <div class="form-group">
            <textarea name="message" placeholder="Nội dung bài đăng..."></textarea>
          </div>
          <div class="form-group flex-row">
            <div class="upload-options" style="flex:1">
              <div class="option">
                <input type="radio" id="urlOption" name="uploadType" value="url" checked>
                <label for="urlOption">Dùng URL phương tiện</label>
                <input type="text" name="mediaUrl" placeholder="Dán URL ảnh/video" class="url-input">
              </div>
            </div>
            <div class="upload-options" style="flex:1; margin-left:1rem;">
              <div class="option">
                <input type="radio" id="uploadOption" name="uploadType" value="upload">
                <label for="uploadOption">Tải lên từ thiết bị</label><br>
                <button type="button" id="uploadBtn" class="upload-btn">Chọn file</button>
                <input type="file" id="fileInput" name="media" accept="image/*,video/*" style="display: none;">
                <div id="fileInfo" style="font-size:0.9em; margin-top:8px;">
                  <span id="fileName">Chưa chọn file</span>
                  <span id="fileSize"></span>
                  <span id="fileType"></span>
                </div>
                <div id="previewContainer" style="margin-top: 10px;">
                  <!-- Preview sẽ hiển thị ở đây -->
                </div>
              </div>
            </div>
          </div>
          <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> Đăng bài ngay</button>
        </form>
      </div>
    </section>

    <!-- Section: Bài đăng đã lên lịch -->
    <section class="card" id="section-scheduled">
      <h2><i class="fas fa-calendar"></i> Bài đăng đã lên lịch</h2>
      <div id="scheduledList"></div>
    </section>

    <!-- Section: Quản lý comment mẫu -->
    <section class="card comment-management" id="section-comments">
      <h2><i class="fas fa-envelope-open"></i> Quản lý Comment Mẫu</h2>
      
      <div class="template-form" onsubmit="return false;">
        <textarea id="newTemplate" class="form-control" placeholder="Nhập nội dung comment mẫu..."></textarea>
        <button id="addTemplateBtn" class="submit-btn"><i class="fas fa-plus"></i> Thêm mẫu</button>
      </div>
      
      <div class="template-list">
        <h3>Danh sách comment mẫu</h3>
        <ul id="templatesList"></ul>
      </div>
      
      <div class="auto-comment">
        <h3>Tự động comment</h3>
        <select id="postSelector" class="form-control">
          <option disabled selected>-- Chọn bài đăng muốn comment --</option>
        </select>        
        <button id="autoCommentBtn" class="submit-btn"><i class="fas fa-magic"></i> Comment tự động</button>
      </div>
      <div class="form-group">
        <button id="autoLikeBtn" class="btn-secondary" style="margin-top: 1rem;">Like bài viết</button>
        <button id="autoShareBtn" class="btn-secondary" style="margin-top: 1rem;">Share bài viết</button>
      </div>
    </section>

    <!-- Section: Chatbot AI -->
    <section class="card ai-toggle-section" id="section-ai">
      <div class="ai-toggle-flex">
        <div>
          <h2>🤖 Bật/Tắt Chatbot AI trả lời bình luận</h2>
          <p class="desc">Khi bật, chatbot AI sẽ tự động phản hồi bình luận mới trên Page của bạn.</p>
        </div>
        <div class="ai-toggle-right">
          <label class="switch">
            <input type="checkbox" id="aiToggle">
            <span class="slider round"></span>
          </label>
          <span id="aiStatus" class="ai-status-label"></span>
        </div>
      </div>   
    </section>
  </main>

  <footer>
    © 2025 Auto Marketing Facebook Page | Made by Sơn Phạm
  </footer>

  <script>
    // Xử lý hiển thị trạng thái xác thực
    const urlParams = new URLSearchParams(window.location.search);
    const authStatus = urlParams.get('auth');
    const authButton = document.getElementById('authButton');
    
    if (authStatus === 'success') {
      showToast("Đã xác thực với Facebook!", "success");
      authButton.textContent = 'Đã xác thực';
      authButton.style.backgroundColor = '#4CAF50';
    } else if (authStatus === 'failed') {
      showToast("Xác thực với Facebook thất bại!", "error");
    }

    // Xử lý chọn file và hiển thị preview
    document.getElementById('uploadBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
    
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      const previewContainer = document.getElementById('previewContainer');
      previewContainer.innerHTML = '';
      
      if (file) {
        document.getElementById('fileName').textContent = `Tên file: ${file.name}`;
        document.getElementById('fileSize').textContent = `Kích thước: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;
        document.getElementById('fileType').textContent = `Loại: ${file.type}`;
        
        // Hiển thị preview
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            previewContainer.appendChild(img);
          };
          reader.readAsDataURL(file);
        } else if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.controls = true;
          video.src = URL.createObjectURL(file);
          previewContainer.appendChild(video);
        }
      } else {
        document.getElementById('fileName').textContent = 'Chưa chọn file';
        document.getElementById('fileSize').textContent = '';
        document.getElementById('fileType').textContent = '';
      }
    });

    // Xử lý hiển thị form lên lịch
    document.getElementById('postType').addEventListener('change', function() {
      const scheduleFields = document.getElementById('scheduleFields');
      const submitBtn = document.getElementById('submitBtn');
      
      if (this.value === 'schedule') {
        scheduleFields.style.display = 'block';
        submitBtn.textContent = 'Lên lịch đăng bài';
        
        // Set min datetime cho input (hiện tại + 10 phút)
        const now = new Date();
        now.setMinutes(now.getMinutes() + 10);
        document.getElementById('scheduled_time').min = now.toISOString().slice(0, 16);
      } else {
        scheduleFields.style.display = 'none';
        submitBtn.textContent = 'Đăng bài ngay';
      }
    });

    // Load danh sách bài đã lên lịch
    async function loadScheduledPosts() {
      try {
        const response = await fetch('/api/scheduled');
        const posts = await response.json();
        
        const listElement = document.getElementById('scheduledList');
        listElement.innerHTML = '';
        
        if (posts.length === 0) {
          listElement.innerHTML = `<div style="color:#aaa;font-style:italic;">Chưa có bài đăng hẹn lịch nào.</div>`;
          return;
        }
        
        posts.forEach(post => {
          const postElement = document.createElement('div');
          postElement.className = 'scheduled-item';
          
          const time = new Date(post.scheduled_time).toLocaleString();
          
          postElement.innerHTML = `
            <div class="scheduled-info">
              <div>${post.message || '(Không có nội dung)'}</div>
              <div class="scheduled-time">Đăng lúc: ${time}</div>
            </div>
            <div class="scheduled-status status-${post.status}">
              ${post.status === 'scheduled' ? 'Đã lên lịch' : 
                post.status === 'posted' ? 'Đã đăng' : 'Lỗi'}
            </div>
          `;
          
          listElement.appendChild(postElement);
        });
      } catch (error) {
        console.error('Lỗi khi tải bài đã lên lịch:', error);
      }
    }

    // Xử lý submit form
    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const uploadType = document.querySelector('input[name="uploadType"]:checked').value;
      const message = formData.get('message');
      const postType = formData.get('postType');
      
      try {
        let response;
        if (postType === 'now') {
          if (uploadType === 'url') {
            // Gửi yêu cầu đăng bài với URL
            response = await fetch('/api/post', {
              method: 'POST',
              body: JSON.stringify({
                message: formData.get('message'),
                mediaUrl: formData.get('mediaUrl')
              }),
              headers: { 'Content-Type': 'application/json' }
            });
          } else {
            // Gửi yêu cầu upload file
            const file = formData.get('media');
            if (!file || file.size === 0) {
              throw new Error('Vui lòng chọn file phương tiện');
            }
            
            const uploadFormData = new FormData();
            uploadFormData.append('message', message);
            uploadFormData.append('media', file);
            
            response = await fetch('/api/upload', {
              method: 'POST',
              body: uploadFormData
            });
          }
        } else {
          // Xử lý lên lịch bài đăng
          const scheduledTime = formData.get('scheduled_time');
          if (!scheduledTime) {
            throw new Error('Vui lòng chọn thời gian đăng bài');
          }
          
          const uploadFormData = new FormData();
          uploadFormData.append('message', formData.get('message'));
          uploadFormData.append('scheduled_time', scheduledTime);
          
          // Thêm file hoặc URL phương tiện
          const uploadType = document.querySelector('input[name="uploadType"]:checked').value;
          if (uploadType === 'upload') {
            const file = formData.get('media');
            if (file && file.size > 0) {
              uploadFormData.append('media', file);
            }
          } else {
            const mediaUrl = formData.get('mediaUrl');
            if (mediaUrl) {
              uploadFormData.append('mediaUrl', mediaUrl);
            }
          }
          
          response = await fetch('/api/schedule', {
            method: 'POST',
            body: uploadFormData
          });
        }
        
        const data = await response.json();
        
        if (data.success) {
          let toastMsg = "";
          if (postType === 'now') {
            toastMsg = `
              <strong>Đăng bài thành công!</strong><br>
              ID bài đăng: ${data.postId}<br>
              Loại: ${data.type}
            `;
            if (data.type === 'video' && data.duration) {
              toastMsg += `<br>Thời lượng: ${Math.round(data.duration)} giây`;
            }
            // Reset form như cũ
            e.target.reset();
            document.getElementById('fileName').textContent = 'Chưa chọn file';
            document.getElementById('fileSize').textContent = '';
            document.getElementById('fileType').textContent = '';
            document.getElementById('previewContainer').innerHTML = '';
          } else {
            toastMsg = `
              <strong>Đã lên lịch bài đăng thành công!</strong><br>
              ID lịch đăng: ${data.postId}<br>
              Thời gian đăng: ${new Date(data.scheduled_time).toLocaleString()}
            `;
            loadScheduledPosts();
          }
          showToast(toastMsg, "success");
          e.target.reset();
        } else {
          throw new Error(data.error || 'Đăng bài thất bại');
        }
      } catch (error) {
        showToast(`<strong>Lỗi:</strong> ${error.message}`, "error");
      }
    });

    // Tải danh sách bài đã lên lịch khi trang load
    loadScheduledPosts();

    // Load danh sách comment mẫu
    async function loadTemplates() {
      const response = await fetch('/api/comment-templates');
      const templates = await response.json();
      
      const listElement = document.getElementById('templatesList');
      listElement.innerHTML = '';
      
      templates.forEach(template => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${template.content}</span>
          <button onclick="deleteTemplate(${template.id})">Xóa</button>
        `;
        listElement.appendChild(li);
      });
    }

    // Thêm comment mẫu
    document.getElementById('addTemplateBtn').addEventListener('click', async () => {
      const content = document.getElementById('newTemplate').value.trim();
      if (!content) return;
      try {
        const response = await fetch('/api/comment-templates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        
        if (response.ok) {
          document.getElementById('newTemplate').value = '';
          loadTemplates();
          showToast("Đã thêm comment mẫu!", "success");
        } else {
          const data = await response.json();
          throw new Error(data.error || "Lỗi không xác định");
        }
      } catch (error) {
        showToast(`Lỗi thêm comment mẫu: ${error.message}`, "error");
      }
    });

    // Tự động comment
    document.getElementById('autoCommentBtn').addEventListener('click', async () => {
      const postId = document.getElementById('postSelector').value;
      if (!postId) {
        showToast('Vui lòng chọn bài đăng', 'error');
        return;
      }

      try {
        const response = await fetch('/api/auto-comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postId })
        });

        const result = await response.json();

        if (result.success) {
          showToast(`
            <strong>Comment thành công!</strong><br>
            Comment ID: ${result.commentId}<br>
            Template used: ${result.templateUsed}
          `, "success");
        } else {
          throw new Error(result.error || result.details);
        }
      } catch (error) {
        showToast(`<strong>Lỗi:</strong> ${error.message}`, "error");
      }
    });

    // Hàm xóa comment mẫu
    async function deleteTemplate(id) {
      if (!confirm('Bạn chắc chắn muốn xóa comment mẫu này?')) return;
      
      try {
        const response = await fetch(`/api/comment-templates/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          loadTemplates();
          showToast("Đã xóa comment mẫu!", "success");
        } else {
          throw new Error('Xóa không thành công');
        }
      } catch (error) {
        showToast(`Lỗi: ${error.message}`, 'error');
      }
    }

    // Cập nhật hàm loadTemplates để hiển thị tốt hơn
    async function loadTemplates() {
      try {
        const response = await fetch('/api/comment-templates');
        const templates = await response.json();
        
        const listElement = document.getElementById('templatesList');
        listElement.innerHTML = '';
        
        if (templates.length === 0) {
          listElement.innerHTML = '<li>Chưa có comment mẫu nào</li>';
          return;
        }
        
        templates.forEach(template => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="template-content">${template.content}</div>
            <div class="template-actions">
              <button class="btn-delete" onclick="deleteTemplate(${template.id})">Xóa</button>
            </div>
          `;
          listElement.appendChild(li);
        });
      } catch (error) {
        console.error('Lỗi khi tải comment mẫu:', error);
      }
    }

    // Load templates khi trang được tải
    loadTemplates();

    // Load danh sách Posts
    async function loadPosts() {
    try {
      const response = await fetch('/api/page-posts');
      const posts = await response.json();
      const selector = document.getElementById('postSelector');
      selector.innerHTML = '<option disabled selected>-- Chọn bài đăng muốn comment --</option>';

      posts.forEach(post => {
        const option = document.createElement('option');
        option.value = post.id;
        const preview = post.message ? post.message.slice(0, 50).replace(/\n/g, ' ') : '[Không có nội dung]';
        option.textContent = `${preview} (ID: ${post.id})`;
        selector.appendChild(option);
      });
    } catch (err) {
      console.error('Lỗi khi tải danh sách post:', err);
    }
  }

  loadPosts();

  // Xử lý Like và Share
  document.getElementById('autoLikeBtn').addEventListener('click', async () => {
    const postId = document.getElementById('postSelector').value;
    if (!postId) {
      showToast('Vui lòng chọn bài đăng', 'error');
      return;
    }

    try {
      const response = await fetch('/api/auto-like', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId })
      });

      const result = await response.json();
      if (result.success) {
        showToast('Đã like bài viết thành công!', 'success');
      } else {
        throw new Error(result.error || result.details);
      }
    } catch (error) {
      showToast('Lỗi khi like bài viết: ' + error.message, "error");
    }
  });

  document.getElementById('autoShareBtn').addEventListener('click', async () => {
    const postId = document.getElementById('postSelector').value;
    if (!postId) {
      showToast('Vui lòng chọn bài đăng', 'error');
      return;
    }

    try {
      const response = await fetch('/api/auto-share', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId })
      });

      const result = await response.json();
      if (result.success) {
        showToast(`Đã share bài viết thành công! ID mới: ${result.sharedPostId}`, 'success');
      } else {
        throw new Error(result.error || result.details);
      }
    } catch (error) {
      showToast('Lỗi khi share bài viết: ' + error.message, "error");
    }
  });

  // Xử lý toggle bật/tắt AI chatbot
  async function updateAiToggleUI() {
    try {
      const res = await fetch('/api/ai-reply-enabled');
      const data = await res.json();
      document.getElementById('aiToggle').checked = data.enabled;
      const aiStatus = document.getElementById('aiStatus');
      if (data.enabled) {
        aiStatus.textContent = 'ĐÃ BẬT';
        aiStatus.style.color = '#21b573'; // xanh lá dễ nhận diện
      } else {
        aiStatus.textContent = 'ĐÃ TẮT';
        aiStatus.style.color = '#b0b0b0';
      }
    } catch (e) {
      document.getElementById('aiStatus').textContent = 'Không xác định';
      document.getElementById('aiStatus').style.color = '#b0b0b0';
    }
  }

  document.getElementById('aiToggle').addEventListener('change', async function() {
    await fetch('/api/ai-reply-enabled', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ enabled: this.checked })
    });
    updateAiToggleUI();
  });
  updateAiToggleUI();

  // Hàm showToast
  function showToast(message, type = "success") {
    const toast = document.getElementById("toast");
    toast.innerHTML = message; // Sử dụng innerHTML thay vì innerText
    toast.style.background = type === "error" ? "#d32f2f" : "#1976d2";
    toast.style.color = "#fff";
    toast.style.display = "block";
    toast.style.opacity = 1;
    setTimeout(() => {
      toast.style.opacity = 0;
      setTimeout(() => { toast.style.display = "none"; }, 300);
    }, 2800);
  }

  // Responsive navbar toggle
  document.getElementById('navToggle').onclick = function() {
    document.querySelector('.nav-menu').classList.toggle('active');
  };
  </script>
</body>
</html>